{% extends "admin.html" %}
{% from "macros/code_editor.html" import render_editor %}

{% block title %} Class {% endblock %} 

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="Objects">{{ _('Objects')}}</a></li>
<li class="breadcrumb-item"><a href="Objects?view=class&class={{id}}">{{form.name.data}}</a></li>
{% endblock %}

{% block module_content %}

{% if form.errors %}
<div class="alert alert-warning mt-3">
    <ul>
    {% for field, errors in form.errors.items() %}
        {% for error in errors %}
            <li>{{field}}: {{ error }}</li>
        {% endfor %}
    {% endfor %}
    </ul>
</div>
{% endif %}
<style>
    /* Используем flexbox для выравнивания вкладок */
    .nav-tabs {
      display: flex;
    }
    /* Добавляем маржин слева для первых вкладок, чтобы их выровнять по правому краю */
    .nav-item:not(:last-child) {
      margin-right: auto;
    }
</style>
<!-- Подключение стилей Prism -->
<link rel="stylesheet" href="{{ config.ASSETS_ROOT }}/plugins/prism/prism.min.css">
<!-- Подключение скриптов Prism -->
<script src="{{ config.ASSETS_ROOT }}/plugins/prism/prism.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/prism/prism-python.min.js"></script>

<ul class="nav nav-tabs" id="configTabs" role="tablist">
    <li class="nav-item">
        <a class="nav-link tab-button {% if tab == ''%}active{%endif%}" href="#general" data-bs-toggle="tab" role="tab">{{ _('General')}}</a>
    </li>
    {% if id %}
    <li class="nav-item">
        <button class="nav-link tab-button{% if tab == 'properties'%} active{%endif%}" href="#properties" data-bs-toggle="tab" role="tab">
            {{ _('Properties')}} <a href="?view=property&class={{id}}" class="btn btn-success btn-sm ms-2" title="{{ _('Add property')}}"><i class="fas fa-plus"></i></a>
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link tab-button{% if tab == 'methods'%} active{%endif%}" href="#methods" data-bs-toggle="tab" role="tab">
            {{ _('Methods')}} <a href="?view=method&class={{id}}" class="btn btn-success btn-sm ms-2" title="{{ _('Add method')}}"><i class="fas fa-plus"></i></a>
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link tab-button{% if tab == 'objects'%} active{%endif%}" href="#objects" data-bs-toggle="tab" role="tab">
            {{ _('Objects')}} <a href="?view=object&class={{id}}" class="btn btn-success btn-sm ms-2" title="{{ _('Add object')}}"><i class="fas fa-plus"></i></a>
        </button>
    </li>
    <li class="nav-item"><a class="nav-link tab-button{% if tab == 'template'%} active{%endif%}" href="#template_tab" data-bs-toggle="tab" role="tab">{{ _('Template')}}</a></li>
    <li class="nav-item"><a class="nav-link tab-button" href="?view=class&class={{id}}&tab=permissions">{{ _('Permissions')}}</a></li>
    <li class="nav-item flex-grow-1"> <!-- flex-grow-1 для заполнения промежутка -->
        <!-- Пустой элемент, чтобы создать промежуток -->
      </li>
    <li class="nav-item ml-auto"> <!-- Используем ml-auto для выравнивания последней вкладки справа -->
        <a class="nav-link tab-button" data-bs-toggle="tab" href="#tools">{{ _('Tools')}}</a>
    </li>
    {%endif%}
</ul>
<div class="tab-content mt-3" id="myTabContent">
    <div class="tab-pane fade {% if tab == ''%}show active{%endif%}" id="general" role="tabpanel" aria-labelledby="general-tab">
        <form method="POST">
            <!-- Поля формы -->
            {{ form.hidden_tag() }}
            <div class="mb-3">
                <label class="form-label">{{ _('Name') }}</label>
                {{ form.name(class="form-control") }}
            </div>
            <div class="mb-3">
                <label class="form-label">{{ _('Description') }}</label>
                {{ form.description(class="form-control") }}
            </div>
            <div class="mb-3">
                <label class="form-label">{{ _('Parent') }}</label>
                {{ form.parent_id(class="form-control") }}
            </div>
            <!-- Кнопка отправки формы -->
            <button type="submit" class="btn btn-primary"><i class="fas fa-check me-2"></i>{{ _('Submit')}}</button>
            <a href="Objects" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>{{ _('Cancel')}}</a>
        </form>
    </div>
    <div class="tab-pane fade {% if tab == 'properties'%}show active{%endif%}" id="properties" role="tabpanel" aria-labelledby="properties-tab">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        {% if show_id %}
                        <th style="width:1%; white-space:nowrap;">ID</th>
                        {% endif %}
                        <th style="width:25%;">{{ _('Name')}}</th>
                        <th style="width:55%;">{{ _('Description')}}</th>
                        <th style="width:10%; white-space:nowrap;">{{ _('Type')}}</th>
                        <th style="width:9%;"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for property in properties %}
                    {# Полупрозрачный фон для строки, если задан color и он не чёрный #}
                    {% set _color = property.color|lower if property.color else '' %}
                    {% if _color in ['#000', '#000000', 'black'] %}
                        {% set row_bg = '' %}
                    {% else %}
                        {% set row_bg = _color ~ '26' if _color else '' %}
                    {% endif %}
                    <tr>
                        {% if show_id %}
                        <td style="width:1%; white-space:nowrap;{% if row_bg %} background-color: {{ row_bg }};{% endif %}">
                            <span class="badge bg-secondary text-light" style="font-size:0.65rem;">{{ property.id }}</span>
                        </td>
                        {% endif %}
                        <td{% if row_bg %} style="background-color: {{ row_bg }};"{% endif %}>
                            <div class="d-flex align-items-start">
                                {% if property.icon %}
                                    {% if ':' in property.icon %}
                                        <iconify-icon icon="{{ property.icon }}" title="{{ _('Property icon') }}" class="p-2 me-2" style="font-size:1.25rem;"></iconify-icon>
                                    {% else %}
                                        <i class="{{ property.icon }} p-2 me-2" title="{{ _('Property icon') }}" style="font-size:1.25rem;"></i>
                                    {% endif %}
                                {% endif %}
                                <div>
                                    <div class="fw-semibold">{{ property.name }}</div>
                                    <div class="small text-muted">
                                        {% if property.description %}
                                            {{ property.description }}
                                        {% else %}
                                            {{ _('Description is empty')}}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td{% if row_bg %} style="background-color: {{ row_bg }};"{% endif %}>
                            {% if property.history %}
                                <div class="small text-muted mb-1">
                                    <span class="badge bg-warning text-dark" style="font-size:0.65rem;">
                                        {{ _('History')}}: {{property.history}} {{ _('days')}}
                                    </span>
                                </div>
                            {% endif %}
                            {% if property.method %}
                                <div class="mt-1">
                                    <span class="badge bg-primary text-light" style="font-size:0.7rem;">
                                        {{ _('Method')}}: {{property.method}}
                                    </span>
                                </div>
                            {% endif %}
                            {# Краткое отображение параметров валидации #}
                            <div class="small text-muted mt-1">
                                {% if property.params['min'] or property.params['max'] %}
                                    <span class="badge bg-warning text-dark me-1" style="font-size:0.65rem;">
                                        {% if property.params['min']!='' %}
                                            {{ _('Minimum Value')}}: {{ property.params['min'] }}
                                        {% endif %}
                                        {% if property.params['max']!=''%}
                                            {% if property.params['min'] %} / {% endif %}
                                            {{ _('Maximum Value')}}: {{ property.params['max'] }}
                                        {% endif %}
                                    </span>
                                {% endif %}
                                {% if property.params['step'] %}
                                    <span class="badge bg-warning text-dark me-1" style="font-size:0.65rem;">
                                        {{ _('Step')}}: {{ property.params['step'] }}
                                    </span>
                                {% endif %}
                                {% if property.params['decimals'] %}
                                    <span class="badge bg-warning text-dark me-1" style="font-size:0.65rem;">
                                        {{ _('Decimals')}}: {{ property.params['decimals'] }}
                                    </span>
                                {% endif %}
                                {% if property.params['allowed_values'] %}
                                    <span class="badge bg-info text-dark me-1" style="font-size:0.65rem;">
                                        {{ _('Allowed values')}}: {{ property.params['allowed_values']|length }}
                                    </span>
                                {% endif %}
                                {% if property.params['enum_values'] %}
                                    <span class="badge bg-info text-dark me-1" style="font-size:0.65rem;">
                                        {{ _('Enum Values (JSON)')}}: {{ property.params['enum_values']|length }}
                                    </span>
                                {% endif %}
                                {% if property.params['default_value'] %}
                                    <span class="badge bg-success text-light me-1" style="font-size:0.65rem;">
                                        {{ _('Default Value')}}: {{ property.params['default_value'] }}
                                    </span>
                                {% endif %}
                                {% if property.params['regexp'] %}
                                    <span class="badge bg-dark text-light me-1" style="font-size:0.65rem;">
                                        {{ _('RegExp Pattern')}}
                                    </span>
                                {% endif %}
                                {% if property.params['rate_limit'] %}
                                    <span class="badge bg-danger text-dark me-1" style="font-size:0.65rem;">
                                        {{ _('Rate Limit (seconds)')}}: {{ property.params['rate_limit'] }}
                                    </span>
                                {% endif %}
                                {% if property.params['read_only'] %}
                                    <span class="badge bg-secondary text-light me-1" style="font-size:0.65rem;">
                                        {{ _('Read Only')}}
                                    </span>
                                {% endif %}
                            </div>
                        </td>
                        <td{% if row_bg %} style="background-color: {{ row_bg }};"{% endif %}>
                            <span class="badge bg-secondary">{{ property.type }}</span>
                        </td>
                        <td class="text-end"{% if row_bg %} style="background-color: {{ row_bg }};"{% endif %}>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="?view=property&class={{id}}&property={{property.id}}&op=edit"
                                   class="btn btn-outline-success"
                                   title="{{ _('Edit')}}">
                                    <i class="fas fa-pencil-alt"></i>
                                </a>
                                <a href="?view=property&class={{id}}&property={{property.id}}&op=delete"
                                   onClick="return confirm('Delete record?')"
                                   class="btn btn-outline-danger"
                                   title="{{ _('Delete')}}">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% if parent_properties %}
                    <tr>
                        <td colspan="{{ 4 + (1 if show_id else 0) }}" class="pt-3 pb-1">
                            <span class="text-muted" style="font-size:0.8rem; border-top: 1px solid rgba(255,255,255,0.08); display:block; padding-top:0.35rem;">
                                {{ _('Parent properties') }}
                            </span>
                        </td>
                    </tr>
                    {% endif %}
                    {% for property in parent_properties %}
                    {# Для родительских свойств используем те же icon/color, если заданы #}
                    {% set _color = property.color|lower if property.color else '' %}
                    {% if _color in ['#000', '#000000', 'black'] %}
                        {% set row_bg = '' %}
                    {% else %}
                        {% set row_bg = _color ~ '26' if _color else '' %}
                    {% endif %}
                    <tr>
                        {% if show_id %}
                        <td style="width:1%; white-space:nowrap;{% if row_bg %} background-color: {{ row_bg }};{% endif %}">
                            <span class="badge bg-secondary text-light" style="font-size:0.65rem;">{{ property.id }}</span>
                        </td>
                        {% endif %}
                        <td{% if row_bg %} style="background-color: {{ row_bg }};"{% endif %}>
                            <div class="d-flex align-items-start">
                                {% if property.icon %}
                                    {% if ':' in property.icon %}
                                        <iconify-icon icon="{{ property.icon }}" title="{{ _('Property icon') }}" class="p-2 me-2" style="font-size:1.25rem;"></iconify-icon>
                                    {% else %}
                                        <i class="{{ property.icon }} p-2 me-2" title="{{ _('Property icon') }}" style="font-size:1.25rem;"></i>
                                    {% endif %}
                                {% endif %}
                                <div>
                                    <div class="fw-semibold">
                                        {{property.class_name}} → <b>{{ property.name }}</b>
                                    </div>
                                    <div class="small text-muted">
                                        {% if property.description %}
                                            {{ property.description }}
                                        {% else %}
                                            {{ _('Description is empty')}}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td{% if row_bg %} style="background-color: {{ row_bg }};"{% endif %}>
                            {% if property.history %}
                                <div class="small text-muted mb-1">
                                    <span class="badge bg-warning text-dark" style="font-size:0.65rem;">
                                        {{ _('History')}}: {{property.history}} {{ _('days')}}
                                    </span>
                                </div>
                            {% endif %}
                            {% if property.method %}
                                <div class="mt-1">
                                    <span class="badge bg-primary text-light" style="font-size:0.7rem;">
                                        {{ _('Method')}}: {{property.method}}
                                    </span>
                                </div>
                            {% endif %}
                            <div class="small text-muted mt-1">
                                {% if property.params['min'] or property.params['max'] %}
                                    <span class="badge bg-warning text-dark me-1" style="font-size:0.65rem;">
                                        {% if property.params['min']!='' %}
                                            {{ _('Minimum Value')}}: {{ property.params['min'] }}
                                        {% endif %}
                                        {% if property.params['max']!=''%}
                                            {% if property.params['min'] %} / {% endif %}
                                            {{ _('Maximum Value')}}: {{ property.params['max'] }}
                                        {% endif %}
                                    </span>
                                {% endif %}
                                {% if property.params['step'] %}
                                    <span class="badge bg-warning text-dark me-1" style="font-size:0.65rem;">
                                        {{ _('Step')}}: {{ property.params['step'] }}
                                    </span>
                                {% endif %}
                                {% if property.params['decimals'] %}
                                    <span class="badge bg-warning text-dark me-1" style="font-size:0.65rem;">
                                        {{ _('Decimals')}}: {{ property.params['decimals'] }}
                                    </span>
                                {% endif %}
                                {% if property.params['allowed_values'] %}
                                    <span class="badge bg-info text-dark me-1" style="font-size:0.65rem;">
                                        {{ _('Allowed values')}}: {{ property.params['allowed_values']|length }}
                                    </span>
                                {% endif %}
                                {% if property.params['enum_values'] %}
                                    <span class="badge bg-info text-dark me-1" style="font-size:0.65rem;">
                                        {{ _('Enum Values (JSON)')}}: {{ property.params['enum_values']|length }}
                                    </span>
                                {% endif %}
                                {% if property.params['default_value'] %}
                                    <span class="badge bg-success text-light me-1" style="font-size:0.65rem;">
                                        {{ _('Default Value')}}: {{ property.params['default_value'] }}
                                    </span>
                                {% endif %}
                                {% if property.params['regexp'] %}
                                    <span class="badge bg-dark text-light me-1" style="font-size:0.65rem;">
                                        {{ _('RegExp Pattern')}}
                                    </span>
                                {% endif %}
                                {% if property.params['rate_limit'] %}
                                    <span class="badge bg-danger text-dark me-1" style="font-size:0.65rem;">
                                        {{ _('Rate Limit (seconds)')}}: {{ property.params['rate_limit'] }}
                                    </span>
                                {% endif %}
                                {% if property.params['read_only'] %}
                                    <span class="badge bg-secondary text-light me-1" style="font-size:0.65rem;">
                                        {{ _('Read Only')}}
                                    </span>
                                {% endif %}
                            </div>
                        </td>
                        <td{% if row_bg %} style="background-color: {{ row_bg }};"{% endif %}>
                            <span class="badge bg-secondary">{{ property.type }}</span>
                        </td>
                        <td class="text-end"{% if row_bg %} style="background-color: {{ row_bg }};"{% endif %}>
                            <a href="?view=property&class={{id}}&property={{property.id}}&op=redefine"
                               class="btn btn-outline-info btn-sm"
                               role="button">
                                <i class="fas fa-redo me-1"></i>{{ _('Redefine')}}
                            </a>
                        </td>
                    </tr>
                    {% endfor %}

                </tbody>
            </table>
        </div>
        <a href="Objects" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>{{ _('Cancel')}}</a>
    </div>
    <div class="tab-pane fade {% if tab == 'methods'%}show active{%endif%}" id="methods" role="tabpanel" aria-labelledby="methods-tab">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        {% if show_id %}
                        <th style="width:1%; white-space:nowrap;">ID</th>
                        {% endif %}
                        <th style="width:30%;">{{ _('Name')}}</th>
                        <th style="width:60%;">{{ _('Description')}}</th>
                        <th style="width:9%;"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for method in methods %}
                    <tr>
                        {% if show_id %}
                        <td style="width:1%; white-space:nowrap;">
                            <span class="badge bg-secondary text-light" style="font-size:0.65rem;">{{ method.id }}</span>
                        </td>
                        {% endif %}
                        <td>
                            <div class="fw-semibold">{{ method.name }}</div>
                        </td>
                        <td>
                            <div class="small text-muted">
                                {% if method.description %}
                                    {{ method.description }}
                                {% else %}
                                    {{ _('Description is empty')}}
                                {% endif %}
                            </div>
                        </td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="?view=method&class={{id}}&method={{method.id}}&op=edit"
                                   class="btn btn-outline-success"
                                   title="{{ _('Edit')}}">
                                    <i class="fas fa-pencil-alt"></i>
                                </a>
                                <a href="?view=method&class={{id}}&method={{method.id}}&op=delete"
                                   onClick="return confirm('Delete record?')"
                                   class="btn btn-outline-danger"
                                   title="{{ _('Delete')}}">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% if parent_methods %}
                    <tr>
                        <td colspan="{{ 3 + (1 if show_id else 0) }}" class="pt-3 pb-1">
                            <span class="text-muted" style="font-size:0.8rem; border-top: 1px solid rgba(255,255,255,0.08); display:block; padding-top:0.35rem;">
                                {{ _('Parent methods') }}
                            </span>
                        </td>
                    </tr>
                    {% endif %}
                    {% for method in parent_methods %}
                    <tr>
                        {% if show_id %}
                        <td style="width:1%; white-space:nowrap;">
                            <span class="badge bg-secondary text-light" style="font-size:0.65rem;">{{ method.id }}</span>
                        </td>
                        {% endif %}
                        <td>
                            <div class="fw-semibold">
                                {{method.class_name}} → <b>{{ method.name }}</b>
                            </div>
                        </td>
                        <td>
                            <div class="small text-muted">
                                {% if method.description %}
                                    {{ method.description }}
                                {% else %}
                                    {{ _('Description is empty')}}
                                {% endif %}
                            </div>
                        </td>
                        <td class="text-end">
                            {% set has_method = False %}
                            {% for m in methods %}
                                {% if m.name == method.name %}
                                    {% set has_method = True %}
                                {% endif %}
                            {% endfor %}

                            {% if not has_method %}
                            <a href="?view=method&class={{id}}&method={{method.id}}&op=redefine"
                               class="btn btn-outline-info btn-sm"
                               role="button">
                                <i class="fas fa-redo me-1"></i>{{ _('Redefine')}}
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <a href="Objects" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>{{ _('Cancel')}}</a>
    </div>
    <div class="tab-pane fade {% if tab == 'objects'%}show active{%endif%}" id="objects" role="tabpanel" aria-labelledby="objects-tab">
        {%if objects %}
        <ul class="list-group list-group-flush ps-2 mb-0 me-2">
            {% for obj in objects %}
                {% include 'object_template.html' %}
            {% endfor %}
        </ul>
        {% else %}
        <p class="px-3 ml-2 mt-2">{{ _('No objects')}}</p>
        {% endif %}
        <a href="Objects" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>{{ _('Cancel')}}</a>
    </div>
    <div class="tab-pane fade {% if tab == 'template'%}show active{%endif%}" id="template_tab" role="tabpanel" aria-labelledby="template-tab">
        <form id="formTemplate" method="POST">
            <!-- Поля формы -->
            {{ form.hidden_tag() }}
            <div class="mb-3">
                <label class="form-label">{{ _('Template') }}</label>
                {{ render_editor(form.template, 'html')}}
            </div>
            <!-- Кнопка отправки формы -->
            <button type="submit" class="btn btn-primary"><i class="fas fa-check me-2"></i>{{ _('Submit')}}</button>
            <a href="Objects" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>{{ _('Cancel')}}</a>
            <hr>
            <b>{{ _('Templates (parent)')}}</b>
            <div class="ms-3">
                {%if templates%}
                {% for key,template in templates.items() %}
                    {%if key !=form.name.data%}
                    <b>{{key}}</b><small class="ms-2 text-muted">{{ '{%' }} extends "{{key}}" {{ '%}' }}</small>
                    <pre class="code-block border rounded p-3 mb-3" style="overflow-x: auto;"><code class="language-html">{{template}}</code></pre>
                    {%endif%}
                {%endfor%}
                {%else%}
                None
                {%endif%}
            </div>
        </form>
    </div>
    <div class="tab-pane fade" id="tools" role="tabpanel" aria-labelledby="tools-tab">
        <div class="form-group  mb-2">
            <label>
            <input type="checkbox" class="form-check-input" id="include_objects">
            {{ _('Include objects')}}
            </label>
        </div>

        <div class="form-group mb-2">
            <label>
            <input type="checkbox" class="form-check-input" id="include_children">
            {{ _('Include children')}}
            </label>
        </div>

        <button class="btn btn-primary btn-sm" onclick="downloadFile()"><i class="fas fa-file-export me-2"></i>{{ _('Export class')}}</button>
    </div>
</div>
  <script>
 function downloadFile() {
      const baseUrl = '../api/export/class/{{id}}';
      const params = [];

      if (document.getElementById('include_objects').checked) {
        params.push('objects=1');
      }

      if (document.getElementById('include_children').checked) {
        params.push('children=1');
      }

      const fullUrl = params.length > 0
        ? baseUrl + '?' + params.join('&')
        : baseUrl;

      // Загрузка
      const link = document.createElement('a');
      link.href = fullUrl;
      link.download = '';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
{% include 'includes/code_block_styles.html' %}

{% endblock %}