{% extends "admin.html" %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="Objects">{{ _('Objects')}}</a></li>
{% endblock %}

{% block title %} {{ _('Objects')}} {% endblock %} 

{% block module_content %}
<div class="d-flex align-items-start flex-wrap gap-2 w-100">
  <div class="d-flex flex-wrap gap-2 flex-shrink-0">
    <a href="?view=class" class="btn btn-outline-success" role="button"><i class="fas fa-plus me-2"></i>{{ _('Add class')}}</a>
    <a href="?view=object" class="btn btn-outline-success" role="button"><i class="fas fa-plus me-2"></i>{{ _('Add object')}}</a>
    <a href="?view=permissions" class="btn btn-outline-warning" role="button"><i class="fas fa-shield me-2"></i>{{ _('Permissions (global)')}}</a>
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#settingsModal">
      <i class="fas fa-cog me-2"></i>{{ _('Settings')}}
    </button>
  </div>
  <div class="d-flex flex-grow-1" style="flex: 1 1 320px; min-width: 320px;">
    <div class="input-group flex-grow-1">
      <span class="input-group-text"><i class="fas fa-filter"></i></span>
      <input type="text" id="objectFilter" class="form-control" placeholder="{{ _('Type to filter by name or description') }}">
      <button class="btn btn-outline-secondary" type="button" id="clearFilter"><i class="fas fa-times me-1"></i></button>
    </div>
  </div>
  <div class="d-flex gap-2 flex-wrap flex-shrink-0">
    <a href="../api/export/all" class="btn btn-outline-primary text-nowrap" role="button"><i class="fas fa-file-export me-2"></i>{{ _('Export all')}}</a>
    <a href="#" class="btn btn-outline-primary text-nowrap" role="button"  data-bs-toggle="modal" data-bs-target="#uploadModal"><i class="fas fa-file-import me-2"></i>{{ _('Import from file')}}</a>
  </div>
</div>
<div class="accordion mt-2" id="accordionExample">
  {% for class in classes %}
  {% include 'class_template.html' %}
  {% endfor %}
</div>
{% for obj in objects %}
<ul class="ps-4 mb-0 me-2">
{% include 'object_template.html' %}
</ul>
{% endfor %}
 <!-- Модальное окно с настройками -->
 <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <form  method="POST">
          <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">{{ _('Settings')}}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <!-- Поля формы -->
              {{ form.hidden_tag() }}
              <div class="form-check mb-2">
                {{ form.show_id(class="form-check-input", id="show_id_in_lists") }}
                <label class="form-check-label ms-2" for="show_id_in_lists">{{ _('Show ID in lists') }}</label>
              </div>
              <div class="form-check mb-1">
                {{ form.render(class="form-check-input", id="render_in_list") }}
                <label class="form-check-label ms-2" for="render_in_list">{{ _('View template in list objects') }}</label>
              </div>
           </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-2"></i>{{ _('Close')}}</button>
              <button type="submit" class="btn btn-primary"><i class="fas fa-check me-2"></i>{{ _('Submit')}}</button>
          </div>
          </form>
      </div>
  </div>
</div>

<!-- Модальное окно -->
<div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="uploadModalLabel">{{ _('Upload JSON File')}}</h5>
          </div>
          <form id="uploadForm" enctype="multipart/form-data">
              <div class="modal-body">
                  <div class="form-group mb-2">
                      <label for="file">{{ _('Select JSON File')}}:</label>
                      <input type="file" class="form-control-file" id="file" name="file" accept=".json">
                  </div>
                  <div class="form-group mb-2">
                      <label>
                      <input type="checkbox" class="form-check-input" id="add_class">
                      {{ _('Add classes')}}
                      </label>
                  </div>
                  <div class="form-group mb-2">
                      <label>
                      <input type="checkbox" class="form-check-input" id="add_objects">
                      {{ _('Add objects')}}
                      </label>
                  </div>
                  <div class="form-group">
                      <label>
                      <input type="checkbox" class="form-check-input" id="rewrite">
                      {{ _('Rewrite classes/objects')}}
                      </label>
                  </div>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-2"></i>{{ _('Close')}}</button>
                  <button type="button" class="btn btn-primary" onclick="uploadFile()"><i class="fas fa-cloud-upload me-2"></i>{{ _('Upload')}}</button>
              </div>
          </form>
      </div>
  </div>
</div>
<script>
function loadConfiguration() {
  // Check if local storage is available
  if (typeof(Storage) !== "undefined") {
    // Check if the collapse state is stored
    if (localStorage.getItem('collapseClasses')) {
      // Get the collapse state from local storage
      var collapseState = JSON.parse(localStorage.getItem('collapseClasses'));
      // Loop through each collapse element
      collapseState.forEach(function(item) {
        // Set the collapse state
        var element = $('#' + item.id);
        if (!item.collapsed) {
          element.addClass('show');
        } else {
          element.removeClass('show');
        }
      });
    } else {
      // Initialize collapseState if it's not stored
      var collapseState = [];
      $('[id^="collapse"]').each(function() {
        collapseState.push({id: $(this).attr('id'), collapsed: !$(this).hasClass('show')});
      });
      localStorage.setItem('collapseClasses', JSON.stringify(collapseState));
    }
  
    // Store the collapse state when a collapse element is toggled
    $('[data-bs-toggle="collapse"]').on('click', function () {
      setTimeout(function() {
        var collapseState = [];
        $('[id^="collapse"]').each(function() {
          collapseState.push({id: $(this).attr('id'), collapsed: !$(this).hasClass('show')});
        });
        localStorage.setItem('collapseClasses', JSON.stringify(collapseState));
      }, 500);
    });
  }
}

function filterObjects() {
  var query = $('#objectFilter').val().toLowerCase().trim();
  var hasQuery = query !== '';

  $('.object-item').each(function() {
    var text = ($(this).data('search') || '').toLowerCase();
    var match = !hasQuery || text.indexOf(query) !== -1;
    $(this).toggleClass('d-none', !match);
  });

  $($('.class-card').get().reverse()).each(function() {
    var hasVisibleObjects = $(this).find('.object-item').not('.d-none').length > 0;
    var hasVisibleClasses = $(this).find('.class-card').not('.d-none').length > 0;
    var shouldShow = !hasQuery ? true : (hasVisibleObjects || hasVisibleClasses);
    $(this).toggleClass('d-none', !shouldShow);
  });

  $('ul:has(.object-item)').each(function() {
    var hasVisible = $(this).find('.object-item').not('.d-none').length > 0;
    $(this).toggleClass('d-none', hasQuery && !hasVisible);
  });

  if (hasQuery) {
    var openCollapse = function(collapseEl) {
      if (!collapseEl.length) return;
      if (!collapseEl.hasClass('show')) {
        collapseEl.addClass('show').attr('data-filter-open', '1');
        var header = collapseEl.prev('.card-header').find('[data-bs-target="#' + collapseEl.attr('id') + '"]');
        header.attr('aria-expanded', 'true');
      }
      var parentCollapse = collapseEl.parents('.collapse').first();
      if (parentCollapse.length) {
        openCollapse(parentCollapse);
      }
    };

    $('.object-item').not('.d-none').each(function() {
      var collapse = $(this).closest('.collapse');
      openCollapse(collapse);
    });
  } else {
    $('[data-filter-open="1"]').each(function() {
      var collapseEl = $(this);
      collapseEl.removeClass('show').removeAttr('data-filter-open');
      var header = collapseEl.prev('.card-header').find('[data-bs-target="#' + collapseEl.attr('id') + '"]');
      header.attr('aria-expanded', 'false');
    });
  }
}

function uploadFile() {
            var formData = new FormData($('#uploadForm')[0]);
            console.log(formData)
            const baseUrl = '../api/import';
            const params = [];

            if (document.getElementById('add_class').checked) {
              params.push('classes=1');
            }
            if (document.getElementById('add_objects').checked) {
              params.push('objects=1');
            }
            if (document.getElementById('rewrite').checked) {
              params.push('rewrite=1');
            }

            const fullUrl = params.length > 0
              ? baseUrl + '?' + params.join('&')
              : baseUrl;
            $.ajax({
                url: fullUrl,
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response){
                    success = response.success
                    alert(response.message);
                    if (success) {
                      window.location.href = 'Objects';
                    }
                },
                error: function(xhr, status, error) {
                  console.error(xhr.responseText);
                }
            });
        }

  // Call the function to load configuration after document is loaded
$(document).ready(function() {
  loadConfiguration();
  filterObjects();
  $('#objectFilter').on('input', filterObjects);
  $('#clearFilter').on('click', function() {
    $('#objectFilter').val('');
    filterObjects();
  });
});

</script>
{% endblock %}